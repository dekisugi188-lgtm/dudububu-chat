<!DOCTYPE html>
<html>
<head>
  <title>Dudububu Chat ðŸ’•</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { background:#0f172a; color:white; font-family:sans-serif; margin:0 }
    .login, .chat { padding:20px }
    .chat { display:none }
    input, button {
      padding:10px; border:none; border-radius:8px; margin:5px 0;
      width:100%;
    }
    button { background:#ec4899; color:white }
    #messages div { margin:6px 0 }
    .me { text-align:right }
    .typing { font-size:12px; opacity:.7 }
    .status { font-size:12px; color:#22c55e }
  </style>
</head>
<body>

<div class="login" id="login">
  <h2>Private Chat ðŸ’–</h2>
  <input id="pass" type="password" placeholder="Shared secret password">
  <button onclick="join()">Enter</button>
</div>

<div class="chat" id="chat">
  <div class="status" id="status">Offline</div>
  <div id="messages"></div>
  <div class="typing" id="typing"></div>

  <input id="msg" placeholder="Message..."
    oninput="typing(true)" onblur="typing(false)">
  <input type="file" id="file" accept="image/*,video/*">
  <button onclick="send()">Send</button>
  <button onclick="startCall()">ðŸ“¹ Video Call</button>
</div>

<video id="local" autoplay muted></video>
<video id="remote" autoplay></video>

<script src="/socket.io/socket.io.js"></script>
<script>
const socket = io();
let room = "";
let pc;

function join(){
  room = pass.value;
  socket.emit("join-room", room);
  login.style.display="none";
  chat.style.display="block";
}

socket.on("user-online",()=>status.innerText="Online");
socket.on("user-offline",()=>status.innerText="Offline");

function typing(state){
  socket.emit(state?"typing":"stop-typing");
}
socket.on("typing",()=>typingDiv.innerText="typing...");
socket.on("stop-typing",()=>typingDiv.innerText="");

function send(){
  const file = document.getElementById("file").files[0];
  if(file){
    const reader=new FileReader();
    reader.onload=()=>socket.emit("media",{data:reader.result,type:file.type});
    reader.readAsDataURL(file);
    return;
  }
  socket.emit("message",msg.value);
  add("Me: "+msg.value,"me");
  msg.value="";
}

socket.on("message",(m)=>add("Her: "+m));
socket.on("media",(m)=>{
  if(m.type.startsWith("image")){
    add(`<img src="${m.data}" width="200">`);
  }else{
    add(`<video src="${m.data}" controls width="200"></video>`);
  }
});

function add(html,cls=""){
  const d=document.createElement("div");
  d.innerHTML=html;
  d.className=cls;
  messages.appendChild(d);
}

// VIDEO CALL
async function startCall(){
  pc=new RTCPeerConnection();
  const stream=await navigator.mediaDevices.getUserMedia({video:true,audio:true});
  stream.getTracks().forEach(t=>pc.addTrack(t,stream));
  local.srcObject=stream;

  pc.ontrack=e=>remote.srcObject=e.streams[0];
  pc.onicecandidate=e=>e.candidate&&socket.emit("ice-candidate",e.candidate);

  const offer=await pc.createOffer();
  await pc.setLocalDescription(offer);
  socket.emit("offer",offer);
}

socket.on("offer",async o=>{
  pc=new RTCPeerConnection();
  const stream=await navigator.mediaDevices.getUserMedia({video:true,audio:true});
  stream.getTracks().forEach(t=>pc.addTrack(t,stream));
  local.srcObject=stream;

  pc.ontrack=e=>remote.srcObject=e.streams[0];
  pc.onicecandidate=e=>e.candidate&&socket.emit("ice-candidate",e.candidate);

  await pc.setRemoteDescription(o);
  const ans=await pc.createAnswer();
  await pc.setLocalDescription(ans);
  socket.emit("answer",ans);
});

socket.on("answer",a=>pc.setRemoteDescription(a));
socket.on("ice-candidate",c=>pc.addIceCandidate(c));
</script>
</body>
</html>
